<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>evolution is my revolution</title>
  <style>
    /* ==================================== CSS: Tampilan Terminal Matrix ==================================== */
    body {
      font-family: 'Courier New', monospace;
      background: linear-gradient(rgba(0, 0, 0, 0.85), rgba(0, 0, 0, 0.85)), url('BT5.jpg');
      background-size: cover;
      background-position: center;
      background-attachment: fixed;
      color: #00FF00;
      margin: 0;
      display: flex;
      flex-direction: column;
      height: 100vh;
    }

    /* ======= VIDEO BACKGROUND ======= */
    #bg-video {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      object-fit: cover;
      z-index: -1; /* selalu di belakang */
      opacity: 0.6; /* ubah sesuai kebutuhan */
    }

    header {
      padding: 20px 0 10px 0;
      text-align: center;
      line-height: 1.1;
      border-bottom: 1px solid #00FF00;
    }

    .text {
      font-size: 75px;
      margin-bottom: 0;
      color: #00FF00;
    }

    .text1 {
      font-size: 30px;
      margin-top: 0;
      color: #FF0000;
      animation: blinkText 1s infinite;
    }

    .header-buttons button {
      background: transparent;
      border: 1px solid #00FF00;
      color: #00FF00;
      padding: 8px 15px;
      cursor: pointer;
      border-radius: 4px;
      font-family: 'Courier New', monospace;
      transition: background 0.3s, color 0.3s;
    }

    .highlight-section {
      color: #FFFF00;
      font-weight: bold;
    }

    .header-buttons button:hover {
      background-color: #00FF00;
      color: black;
    }

    .main-container {
      display: flex;
      flex: 1;
      border-top: 1px solid #00FF00;
    }

    .search-panel {
      width: 35%;
      padding: 20px;
      display: flex;
      flex-direction: column;
      border-right: 2px solid #00FF00;
    }

    .search-panel h2 { text-align: center; margin-bottom: 20px; }

    input, select {
      background: transparent;
      border: 1px solid #00FF00;
      color: #00FF00;
      padding: 10px;
      margin-bottom: 15px;
      font-size: 16px;
      border-radius: 4px;
      outline: none;
    }

    .info-text { font-size: 14px; text-align: center; margin-top: 10px; }

    #member-buttons { display: flex; flex-direction: column; gap: 10px; margin-top: 10px; }

    .output-panel {
      flex: 1;
      padding: 20px;
      overflow-y: auto;
      border-left: 2px solid #00FF00;
    }

    .agent-profile { display: flex; gap: 20px; align-items: flex-start; flex-wrap: wrap; }

    .agent-profile pre { flex: 1; white-space: pre-wrap; line-height: 1.4; }

    .agent-profile img {
      width: 135px;
      height: 185px;
      object-fit: cover;
      border: 2px solid #00FF00;
      border-radius: 8px;
      display: none; /* Awalnya disembunyikan */
      opacity: 0; /* Awalnya tidak terlihat */
      transition: opacity 1.2s ease-in-out;
    }

    .doc-buttons { display: flex; gap: 10px; margin-top: 15px; }

    .not-found { color: #FF0000; font-weight: bold; }

    button {
      background: transparent;
      border: 1px solid #00FF00;
      color: #00FF00;
      padding: 8px 12px;
      cursor: pointer;
      border-radius: 4px;
      font-family: 'Courier New', monospace;
      transition: background 0.3s, color 0.3s;
    }

    button:hover { background-color: #00FF00; color: black; }

    .agent-profile pre::after { content: "_"; animation: blink 1s infinite; }

    @keyframes blinkText {
      0%, 50%, 100% { opacity: 1; }
      25%, 75% { opacity: 0; }
    }

    .secret-alert { color: #FF0000; font-weight: bold; animation: blinkSecret 1s infinite; }

    @keyframes blinkSecret {
      0%, 50%, 100% { opacity: 1; }
      25%, 75% { opacity: 0; }
    }

    @media (max-width: 768px) {
      .main-container { flex-direction: column; }
      .search-panel, .output-panel { width: 100%; border: none; border-bottom: 1px solid #00FF00; }
      .agent-profile { flex-direction: column; align-items: center; }
    }

    .security-footnote-line {
      display: flex; align-items: center; gap: 10px;
      font-weight: bold; color: #00FF00; margin-top: 25px; margin-bottom: 5px;
    }

    .catatan-btn {
      background-color: red;
      color: white;
      border: 2px solid red;
      padding: 5px 12px;
      font-family: 'Courier New', monospace;
      cursor: pointer;
      border-radius: 4px;
    }

    .catatan-btn:hover { background-color: darkred; border-color: darkred; }
  </style>
</head>
<body>
  <!-- ===== VIDEO BACKGROUND ===== -->
  <video autoplay muted loop id="bg-video">
    <source src="" type="video/mp4">
    Browser Anda tidak mendukung video tag.
  </video>

  <header>
    <h1 class="text">PORTAL MONITORING TERMINAL</h1>
    <h1 class="text1">DATA RIWAYAT HIDUP</h1>
    <div class="header-buttons">
      <button onclick="goTo('database.html')">back to DATABASE</button>
      <button onclick="goTo('index.html')">LOGOUT</button>
    </div>
  </header>

  <div class="main-container">
    <div class="search-panel">
      <h2>Puslat Kodiklatau</h2>
      <label for="category-filter">Filter By Category:</label>
      <select id="category-filter"><option value=""></option></select>
      <label for="search">Enter the Unit Keyword / Full Name</label>
      <input type="text" id="search" placeholder="">
      <p class="info-text">Select a category and type a keyword, then press ENTER to display a list of members</p>
      <div id="member-buttons"></div>
    </div>

    <!-- TOMBOL CATATAN ADA DI SINI -->
    <div class="output-panel" id="output">
      <div class="agent-profile" id="agent-container">
        <pre id="agent-dossier">Biodata will appear after clicking the member button</pre>
        <img id="agent-photo" src="" alt="Foto Personel">
      </div>
    </div>
  </div>

<script>
  function goTo(url) {
    if (!url || url.trim() === "" || url === "-") {
      alert("❌ File belum tersedia untuk personel ini.");
      return;
    }
    window.location.href = url; // pindah HALAMAN
  }

  // ======== LOAD DATABASE DARI GOOGLE SHEET ========
  let personnelDB = [];
  const DATA_URL = "https://script.google.com/macros/s/AKfycbziCZVe24Fl2vokSkBDHFRfv8rPHoXf9BzpYm7OlbG3Bi6hbuq-nActB6y1LKcX5PGLWw/exec";

  fetch(DATA_URL)
    .then(res => res.json())
    .then(data => {
      personnelDB = (data || []).map(person => {
        let photoURL = (person.photo || "").toString().trim();

        if (photoURL) {
          // 1) drive.google.com/file/d/<id>/view...
          let match = photoURL.match(/\/d\/([a-zA-Z0-9_-]+)(?:\/|$)/);
          if (match && match[1]) {
            photoURL = `https://drive.google.com/uc?export=view&id=${match[1]}`;
          } else {
            // 2) jika berupa sharing link (open?id=...)
            match = photoURL.match(/[?&]id=([a-zA-Z0-9_-]{25,})/);
            if (match && match[1]) {
              photoURL = `https://drive.google.com/uc?export=view&id=${match[1]}`;
            } else {
              // 3) jika hanya id
              if (/^[A-Za-z0-9_-]{25,}$/.test(photoURL)) {
                photoURL = `https://drive.google.com/uc?export=view&id=${photoURL}`;
              }
            }
          }
        } else {
          // default image jika kosong
          photoURL = "https://drive.google.com/uc?export=view&id=13KgFyUzOSIUhfK8qw0skSLOEq5Yj0xp2";
        }

        return { ...person, photo: photoURL };
      });
      console.log("✅ Data loaded & photo links normalized", personnelDB);
      populateCategoryDropdown();
    })
    .catch(err => console.error("❌ Gagal memuat data:", err));

  function populateCategoryDropdown() {
    const categorySelect = document.getElementById("category-filter");
    // clear existing (except first)
    categorySelect.innerHTML = '<option value=""></option>';
    const uniqueCategories = [...new Set(personnelDB.map(p => p.kategori).filter(Boolean))];
    uniqueCategories.sort();
    uniqueCategories.forEach(cat => {
      const opt = document.createElement("option");
      opt.value = cat;
      opt.textContent = cat;
      categorySelect.appendChild(opt);
    });
  }

  // ======== ELEMENTS ========
  const searchInput = document.getElementById("search");
  const dossierEl = document.getElementById("agent-dossier");
  const photoEl = document.getElementById("agent-photo");
  const memberBtnContainer = document.getElementById("member-buttons");
  const agentContainer = document.getElementById("agent-container");
  const outputPanel = document.getElementById("output");

  // ======== FUNGSI UTILITAS ========
  function formatTanggalIndonesia(dateStr) {
    if (!dateStr) return "-";
    let date;
    try {
      date = new Date(dateStr);
      if (!(date instanceof Date) || isNaN(date.getTime())) {
        const parts = dateStr.includes("/") ? dateStr.split("/") : dateStr.split("-");
        if (parts.length === 3) {
          // Asumsi dd/mm/yyyy atau yyyy-mm-dd
          let d = Number(parts[0]), m = Number(parts[1]), y = Number(parts[2]);
          // Jika format kemungkinan yyyy-mm-dd
          if (parts[0].length === 4) {
            y = Number(parts[0]); m = Number(parts[1]); d = Number(parts[2]);
          }
          date = new Date(y, m - 1, d);
        } else {
          return dateStr;
        }
      }
    } catch (e) {
      return dateStr;
    }
    const d = String(date.getDate()).padStart(2, "0");
    const m = String(date.getMonth() + 1).padStart(2, "0");
    const y = date.getFullYear();
    return `${d}/${m}/${y}`;
  }

  function getDetailedDiff(targetDate) {
    if (!(targetDate instanceof Date) || isNaN(targetDate.getTime())) return "-";
    const today = new Date();
    if (targetDate < today) return "Sudah lewat";
    const diffTime = Math.abs(targetDate - today);
    const diffDays = Math.floor(diffTime / (1000 * 60 * 60 * 24));
    const years = Math.floor(diffDays / 365.25);
    const months = Math.floor((diffDays % 365.25) / 30.44);
    const days = Math.floor((diffDays % 365.25) % 30.44);
    return `${years} Tahun ${months} Bulan ${days} Hari`;
  }

  function calculateAge(birthDateStr) {
    if (!birthDateStr) return "-";
    const date = new Date(birthDateStr);
    if (!(date instanceof Date) || isNaN(date.getTime())) return "-";
    const today = new Date();
    let age = today.getFullYear() - date.getFullYear();
    if (today.getMonth() < date.getMonth() || (today.getMonth() === date.getMonth() && today.getDate() < date.getDate())) {
      age--;
    }
    return age;
  }

  function getNextKGB(tmtKGB) {
    if (!tmtKGB) return "-";
    const tmt = new Date(tmtKGB);
    if (!(tmt instanceof Date) || isNaN(tmt.getTime())) return "-";
    const nextKGB = new Date(tmt.getFullYear() + 2, tmt.getMonth(), tmt.getDate());
    const nextKGBformatted = formatTanggalIndonesia(nextKGB.toISOString());
    const diffText = getDetailedDiff(nextKGB);
    return `${nextKGBformatted} (${diffText} lagi)`;
  }

  function getMasaKerja(tmtStr) {
    if (!tmtStr) return "-";
    const tmt = new Date(tmtStr);
    if (!(tmt instanceof Date) || isNaN(tmt.getTime())) return "-";
    const today = new Date();
    let years = today.getFullYear() - tmt.getFullYear();
    let months = today.getMonth() - tmt.getMonth();
    let days = today.getDate() - tmt.getDate();
    if (days < 0) {
      months--;
      const prevMonth = new Date(today.getFullYear(), today.getMonth(), 0);
      days += prevMonth.getDate();
    }
    if (months < 0) {
      years--;
      months += 12;
    }
    return `${years} Tahun ${months} Bulan ${days} Hari`;
  }

  // ======== ANIMASI DAN TAMPILAN ========
  function typeWriter(element, text, agent, callback, speed = 10) {
    element.innerHTML = "";
    let i = 0;
    let buffer = "";
    let nameShown = false;

    function safeHighlight(line) {
      // Jika baris mengandung tag highlight-section atau SECURITY FOOTNOTE dsb
      const highlights = ["[DATA IDENTITAS]", "[DATA DIKUMTI & DIKMILTI]", "[DATA KGB]", "[DATA JABATAN]", "[SECURITY FOOTNOTE]", "[TANDA JASA/KEHORMATAN]"];
      for (const h of highlights) {
        if (line.includes(h)) {
          return `<span class="highlight-section">${escapeHtml(line)}</span>`;
        }
      }
      // RAHASIA special
      if (line.includes("RAHASIA")) {
        return escapeHtml(line).replace(/RAHASIA/g, `<span class="secret-alert">RAHASIA</span>`);
      }
      return escapeHtml(line);
    }

    function escapeHtml(unsafe) {
      return unsafe
        .replace(/&/g, "&amp;")
        .replace(/</g, "&lt;")
        .replace(/>/g, "&gt;");
    }

    function typing() {
      if (i < text.length) {
        const char = text.charAt(i);
        buffer += char;
        // split by newline, map highlight, then join with <br>
        const lines = buffer.split("\n").map(line => safeHighlight(line));
        element.innerHTML = lines.join("<br>");
        // Foto muncul saat "NAMA LENGKAP" sudah diketik (konten text)
        if (!nameShown && element.textContent.includes("NAMA LENGKAP")) {
          nameShown = true;
          setTimeout(() => {
            if (agent && agent.photo) {
              photoEl.src = agent.photo;
              photoEl.style.display = "block";
              setTimeout(() => (photoEl.style.opacity = 1), 100);
            }
          }, 200);
        }
        i++;
        outputPanel.scrollTop = outputPanel.scrollHeight;
        setTimeout(typing, speed);
      } else {
        if (callback) callback();
      }
    }
    typing();
  }

  function simulateAccessSequence(element, callback) {
    const steps = [
      ">>> initializing secure connection...",
      ">>> accessing PUSLAT KODIKLATAU database node...",
      ">>> verifying security clearance...",
      ">>> clearance level verified (LEVEL-A) ✔",
      ">>> retrieving data riwayat hidup personel... ACCESS GRANTED"
    ];
    let i = 0;
    element.textContent = "";
    function nextStep() {
      if (i < steps.length) {
        element.textContent += steps[i] + "\n";
        outputPanel.scrollTop = outputPanel.scrollHeight;
        i++;
        setTimeout(nextStep, 600);
      } else {
        setTimeout(callback, 600);
      }
    }
    nextStep();
  }

  // ======== FILTER DAN TAMPILKAN NAMA ANGGOTA ========
  function showMemberButtons(keyword) {
    memberBtnContainer.innerHTML = "";
    const selectedCategory = document.getElementById("category-filter").value;
    const kw = (keyword || "").toLowerCase();
    const filtered = personnelDB.filter(p => {
      const matchKeyword = (p.satker && p.satker.toLowerCase().includes(kw)) ||
                           (p.nama_lengkap && p.nama_lengkap.toLowerCase().includes(kw)) ||
                           (p.kategori && p.kategori.toLowerCase().includes(kw));
      const matchCategory = !selectedCategory || p.kategori === selectedCategory;
      return matchKeyword && matchCategory;
    });

    if (filtered.length === 0) {
      memberBtnContainer.innerHTML = '<span class="not-found">❌ No members found for this filter</span>';
    } else {
      filtered.forEach(agent => {
        const btn = document.createElement("button");
        btn.textContent = agent.nama_lengkap || "(no name)";
        btn.onclick = () => displayAgent(agent);
        memberBtnContainer.appendChild(btn);
      });
    }
  }

  // ======== TAMPILKAN BIODATA DETAIL ========
  function displayAgent(agent) {
    dossierEl.textContent = "Processing...";
    photoEl.style.display = "none";
    photoEl.style.opacity = 0;

    // set foto default atau dari agent
    if (agent && agent.photo) {
      photoEl.src = agent.photo;
    } else {
      photoEl.src = "https://drive.google.com/uc?export=view&id=13KgFyUzOSIUhfK8qw0skSLOEq5Yj0xp2";
    }

    // hapus tombol dokumen lama
    const oldDocs = agentContainer.querySelector(".doc-buttons");
    if (oldDocs) oldDocs.remove();

    simulateAccessSequence(dossierEl, () => {
      const masaKerja = getMasaKerja(agent && agent.tmt_jabatan_saat_ini);
      const nextKGBInfo = getNextKGB(agent && agent.tmt_kgb);
      const usia = calculateAge(agent && agent.tanggal_lahir);

      const dossier = `
========================================
| FILE: PERSONEL PUSLAT KODIKLATAU
| CLASSIFICATION: RAHASIA
========================================
[DATA IDENTITAS]
--------------------------------------------------
NAMA LENGKAP : ${agent && (agent.nama_lengkap || "-")}
PANGKAT      : ${agent && (agent.pangkat || "-")}
NRP/NIP      : ${agent && (agent.nrp_nip || "-")}
TEMPAT/TGL LAHIR : ${agent && (agent.tempat_lahir || "-")}, ${formatTanggalIndonesia(agent && agent.tanggal_lahir)}
USIA         : ${usia} Tahun
GOL DARAH    : ${agent && (agent.gol_darah || "-")}
AGAMA        : ${agent && (agent.agama || "-")}

[DATA DIKUMTI & DIKMILTI]
--------------------------------------------------
DIKUMTI      : ${agent && (agent.dikumti || "-")}
TMT DIKUMTI  : ${formatTanggalIndonesia(agent && agent.tmt_dikumti)}
DIKMILTI     : ${agent && (agent.dikmilti || "-")}
TMT DIKMILTI : ${formatTanggalIndonesia(agent && agent.tmt_dikmilti)}

[DATA JABATAN]
--------------------------------------------------
JABATAN YG LALU : ${agent && (agent.jabatan_yg_lalu || "-")}
JABATAN SAAT INI: ${agent && (agent.jab_saat_ini || "-")}
TMT JABATAN     : ${formatTanggalIndonesia(agent && agent.tmt_jabatan_saat_ini)}
MASA KERJA JABATAN : ${masaKerja}

[DATA KGB]
--------------------------------------------------
TMT KGB TERAKHIR : ${formatTanggalIndonesia(agent && agent.tmt_kgb)}
KGB BERIKUTNYA   : ${nextKGBInfo}

[TANDA JASA/KEHORMATAN]
--------------------------------------------------
${agent && (agent.tanda_jasa || "Tidak ada data")}

[SECURITY FOOTNOTE]
<button class="catatan-btn" onclick="openCatatan('${(agent && agent.nama_lengkap) ? encodeURIComponent(agent.nama_lengkap) : ''}')">CATATAN</button>
-----------------------------------------------------
-----------------------------------------------------
This dossier is property of PUSLAT KODIKLATAU. Unauthorized access or duplication is punishable under applicable law.
<END OF FILE>
========================================
Retrieved on: ${new Date().toLocaleString()}
`;

      // Ketik animasi biodata
      typeWriter(dossierEl, dossier, agent, () => {
        // Setelah typing selesai, buat tombol dokumen
        const docContainer = document.createElement("div");
        docContainer.className = "doc-buttons";

        // Ambil link dari kolom spreadsheet (jaga safety jika undefined)
        const mergedLink = (agent && agent.merged_doc_url_riwayat_hidup_personel_puslat) ? agent.merged_doc_url_riwayat_hidup_personel_puslat.toString() : "";

        let pdfLink = "#";
        if (mergedLink && mergedLink.includes("drive.google.com")) {
          const match = mergedLink.match(/[-\w]{25,}/);
          if (match && match[0]) {
            pdfLink = `https://drive.google.com/uc?export=preview&id=${match[0]}`;
          }
        }

        // Tombol di bawah biodata
        const docs = [
          { label: "Pemuktahiran Data", url: "coomingsoon.html" },
          { label: "Riwayat Hidup", url: pdfLink },
          { label: "KU-1", url: "comingsoon.html" }
        ];

        docs.forEach(d => {
          const btn = document.createElement("button");
          btn.textContent = d.label;
          btn.onclick = () => {
            if (!d.url || d.url === "#" || d.url.includes("undefined")) {
              alert("❌ File belum tersedia untuk personel ini.");
              return;
            }
            window.location.href = d.url;
          };
          docContainer.appendChild(btn);
        });

        agentContainer.appendChild(docContainer);
      });
    });
  }

  // ======== EVENT SEARCH ========
  searchInput.addEventListener("input", () => {
    dossierEl.textContent = "Biodata will appear after clicking the member button";
    const oldDocs = agentContainer.querySelector(".doc-buttons");
    if (oldDocs) oldDocs.remove();
    memberBtnContainer.innerHTML = "";
    photoEl.style.display = "none";
    photoEl.style.opacity = 0;
  });

  searchInput.addEventListener("keydown", e => {
    if (e.key === "Enter") {
      const query = searchInput.value.trim();
      if (query) showMemberButtons(query);
    }
  });

  function openCatatan(namaEncoded) {
    // If invoked from encoded name, decode. If blank -> open generic page.
    let name = "";
    try { name = decodeURIComponent(namaEncoded || ""); } catch (e) { name = namaEncoded || ""; }
    if (!name) {
      window.location.href = "catatanpersonel.html";
    } else {
      window.location.href = "catatanpersonel.html?nama=" + encodeURIComponent(name);
    }
  }
</script>
</body>
</html>
