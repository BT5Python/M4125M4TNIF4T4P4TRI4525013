<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Database Personel - PUSLAT KODIKLATAU</title>

<style>
body {
  background-color: black;
  color: #00ff00;
  font-family: "Courier New", monospace;
  padding: 20px;
  font-size: 14px;
}

#terminal-container {
  background-color: black;
  border: 2px solid #00ff00;
  padding: 20px;
  height: 480px;
  overflow-y: auto;
  white-space: pre;
}

button {
  background-color: black;
  color: #00ff00;
  border: 2px solid #00ff00;
  padding: 10px 20px;
  margin-right: 10px;
  cursor: pointer;
  font-weight: bold;
}

button:hover {
  background-color: #00ff00;
  color: black;
}

/* ======= KEDIP SYSTEM ======= */
@keyframes blinkYellow {
  50% { color: yellow; }
}
@keyframes blinkRed {
  50% { color: red; }
}

/* <31 hari */
.blink-yellow {
  animation: blinkYellow 1s infinite;
  font-weight: bold;
}

/* >2 tahun */
.blink-red {
  animation: blinkRed 1s infinite;
  font-weight: bold;
}

.yellow {
  color: yellow;
}
</style>
</head>
<body>

<h2>PUSLAT KODIKLATAU - DATABASE PERSONEL</h2>

<button onclick="tampilkanSemua()">Tampilkan Semua</button>
<button onclick="tampilkanAnggotaMasuk()">Anggota Masuk</button>

<div id="terminal-container"><div id="terminal"></div></div>

<script>
// ======================================
// Ambil data dari Google Apps Script WebApp
// ======================================
function fetchData() {
  return fetch("https://script.google.com/macros/s/AKfycbw71HKzmt8ZPWAU7tZyNxDC_pk0OHSUlO7L3Wp_zIQQS3EW4rZ9ek-0K2Cts6pMasIV/exec")
    .then(response => response.json());
}

// ======================================
// Hitung Masa Dinas dari TMT
// ======================================
function hitungMasa(tmt) {
  if (!tmt) return "-";

  const parts = tmt.split("/");
  if (parts.length !== 3) return "-";

  const dd = parseInt(parts[0]);
  const mm = parseInt(parts[1]) - 1;
  const yyyy = parseInt(parts[2]);

  const tmtDate = new Date(yyyy, mm, dd);
  const now = new Date();

  let selisih = now - tmtDate;
  let hari = Math.floor(selisih / (1000 * 60 * 60 * 24));

  const tahun = Math.floor(hari / 365);
  hari %= 365;
  const bulan = Math.floor(hari / 30);
  hari %= 30;

  return `${tahun} th ${bulan} bln ${hari} hr`;
}

// ======================================
// Konversi Masa â†’ Hitung Total Hari
// ======================================
function masaKeHari(masa) {
  const angka = masa.match(/\d+/g);
  if (!angka || angka.length < 3) return 0;

  const th = parseInt(angka[0]);
  const bl = parseInt(angka[1]);
  const hr = parseInt(angka[2]);

  return th * 365 + bl * 30 + hr;
}

// ======================================
// Tampilkan Semua Personel
// ======================================
function tampilkanSemua() {
  const terminal = document.getElementById("terminal");
  terminal.innerHTML = "Memuat data...\n";

  fetchData().then(data => {
    terminal.innerHTML =
`NO   NAMA                         PANGKAT                  JABATAN                 TMT          KETERANGAN          MASA DINAS
------------------------------------------------------------------------------------------------------------------------------\n`;

    data.forEach(row => {
      const masa = hitungMasa(row.tmt);
      const totalHari = masaKeHari(masa);

      let masaFix = masa;

      // <31 hari = kuning
      if (totalHari < 31) {
        masaFix = `<span class="blink-yellow">${masa}</span>`;
      }
      // > 2 tahun = merah
      else if (totalHari > 730) {
        masaFix = `<span class="blink-red">${masa}</span>`;
      }

      const line =
`${row.no.toString().padEnd(4)} ${row.nama.padEnd(28)} ${row.pangkat.padEnd(22)} ${row.jabatan.padEnd(23)} ${row.tmt.padEnd(12)} ${row.keterangan.padEnd(18)} ${masaFix}\n`;

      // PNS warna kuning statis
      if (String(row.pangkat).toUpperCase().includes("PNS")) {
        terminal.innerHTML += `<span class="yellow">${line}</span>`;
      } else {
        terminal.innerHTML += line;
      }
    });
  });
}

// ======================================
// Tampilkan Anggota Masuk (<31 Hari)
// ======================================
function tampilkanAnggotaMasuk() {
  const terminal = document.getElementById("terminal");
  terminal.innerHTML = "Memuat data Anggota Masuk...\n";

  fetchData().then(data => {
    terminal.innerHTML =
`NO   NAMA                         PANGKAT                  JABATAN                 TMT          MASA DINAS
----------------------------------------------------------------------------------------------------------\n`;

    data.forEach(row => {
      const masa = hitungMasa(row.tmt);
      const totalHari = masaKeHari(masa);

      if (totalHari < 31) {
        const masaFix = `<span class="blink-yellow">${masa}</span>`;

        const line =
`${row.no.toString().padEnd(4)} ${row.nama.padEnd(28)} ${row.pangkat.padEnd(22)} ${row.jabatan.padEnd(23)} ${row.tmt.padEnd(12)} ${masaFix}\n`;

        terminal.innerHTML += line;
      }
    });
  });
}

</script>
</body>
</html>
