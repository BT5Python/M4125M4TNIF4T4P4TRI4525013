<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>PUSLAT KODIKLATAU â€“ DATA PERSONEL</title>
<style>
body {
  background-color: black;
  color: #00ff00;
  font-family: "Courier New", monospace;
  padding: 20px;
  font-size: 12px;
  text-align: left;
}
pre {
  white-space: pre;
  overflow-x: auto;
}

/* BLINK KUNING UNTUK <2 BULAN */
.blink-yellow {
  animation: blinkYellow 1s infinite;
}
@keyframes blinkYellow {
  0% { color: yellow; }
  50% { color: #00ff00; }
  100% { color: yellow; }
}

/* BLINK MERAH UNTUK >=2 TAHUN */
.blink-red {
  animation: blinkRed 0.8s infinite;
}
@keyframes blinkRed {
  0% { color: red; }
  50% { color: #00ff00; }
  100% { color: red; }
}
</style>
</head>
<body>
<pre id="terminal"></pre>

<script>
/****************************************************
 * UTIL: parse date string (supports dd/mm/yyyy or ISO)
 ****************************************************/
function parseDateFlexible(str) {
  if (!str) return null;
  // If already a Date object
  if (Object.prototype.toString.call(str) === '[object Date]') {
    return str;
  }
  // If contains / assume dd/mm/yyyy
  if (typeof str === 'string' && str.indexOf('/') !== -1) {
    const parts = str.split('/').map(s => s.trim());
    if (parts.length >= 3) {
      const d = parseInt(parts[0], 10);
      const m = parseInt(parts[1], 10) - 1;
      const y = parseInt(parts[2], 10);
      return new Date(y, m, d);
    }
  }
  // Try Date constructor (ISO etc)
  const dt = new Date(str);
  if (!isNaN(dt)) return dt;
  return null;
}

/****************************************************
 * HITUNG MASA DINAS
 ****************************************************/
function hitungMasa(tmt) {
  const parsed = parseDateFlexible(tmt);
  if (!parsed) return "-";
  const t = parsed;

  const now = new Date();
  let year = now.getFullYear() - t.getFullYear();
  let month = now.getMonth() - t.getMonth();
  let day = now.getDate() - t.getDate();

  if (day < 0) {
    month--;
    // approximate days in previous month
    const prevMonth = new Date(now.getFullYear(), now.getMonth(), 0);
    day += prevMonth.getDate();
  }
  if (month < 0) {
    year--;
    month += 12;
  }
  return `${year} tahun ${month} bulan`;
}

/****************************************************
 * FORMAT BLINK
 ****************************************************/
function formatMasaBlink(masa) {
  if (!masa || masa === "-") return masa;
  const parts = masa.split(" ");

  const tahun = parseInt(parts[0]) || 0;
  const bulan = parseInt(parts[2]) || 0;

  if (tahun === 0 && bulan < 2) {
    return `<span class='blink-yellow'>${masa}</span>`;
  }
  if (tahun >= 2) {
    return `<span class='blink-red'>${masa}</span>`;
  }
  return masa;
}

/****************************************************
 * DAFTAR ANGGOTA MASUK (<2 BULAN)
 * Build lines array to avoid multiline-string syntax issues
 ****************************************************/
function tampilAnggotaMasuk(data) {
  const lines = [];
  lines.push('');
  lines.push('DAFTAR ANGGOTA MASUK (< 2 BULAN)');
  lines.push('===============================================================');
  lines.push('NO   NAMA                               PANGKAT            JABATAN                              TMT MASUK        MASA DINAS');
  lines.push('---------------------------------------------------------------------------------------------------------------------------');

  data.forEach(row => {
    if (!row || !row.tmt_masuk) return;

    const masa = hitungMasa(row.tmt_masuk);
    const tahun = parseInt(masa.split(" ")[0]) || 0;
    const bulan = parseInt(masa.split(" ")[2]) || 0;

    if (tahun === 0 && bulan < 2) {
      const line = `${String(row.no || '').padEnd(5)}${String(row.nama || '').padEnd(35)}${String(row.pangkat || '').padEnd(20)}${String(row.jabatan || '').padEnd(32)}${String(row.tmt_masuk || '').padEnd(16)}${masa}`;
      lines.push(line);
    }
  });

  lines.push('');
  return lines.join('
');
}

/****************************************************
 * LOAD DATA DARI APPS SCRIPT
 ****************************************************/
async function loadData() {
  try {
    const res = await fetch("https://script.google.com/macros/s/AKfycbz8BEN43Zo0lL5tkow9Tj0SdI81hFWHhjNsunasfKNP1yu1uKFPMrGm7Z7F48jLRy8/exec");
    const data = await res.json();

    const lines = [];
    lines.push('DATA PERSONEL PUSLAT KODIKLATAU');
    lines.push('========================================================================================================================');
    lines.push('NO   NAMA                               PANGKAT            JABATAN                              TMT MASUK        TMT KELUAR       KET                 MASA DINAS');
    lines.push('------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------');

    data.forEach(row => {
      const masa = hitungMasa(row.tmt_masuk);
      const masaHTML = formatMasaBlink(masa);

      // We will keep masaHTML as plain text for pre block; since we want colored spans, use innerHTML later
      const line = `${String(row.no || '').padEnd(5)}${String(row.nama || '').padEnd(35)}${String(row.pangkat || '').padEnd(20)}${String(row.jabatan || '').padEnd(42)}${String(row.tmt_masuk || '').padEnd(18)}${String(row.tmt_keluar || '').padEnd(18)}${String(row.keterangan || '').padEnd(20)}${masa}`;
      lines.push(line);
    });

    // Add anggota masuk block
    lines.push(tampilAnggotaMasuk(data));

    // Render to terminal: we want to allow span coloring for masa, so we'll replace masa occurrences with formatted span
    const rawText = lines.join('
');

    // Replace masa patterns (e.g., "0 tahun 1 bulan" or "2 tahun 0 bulan") with formatted spans
    // Build a map of masa -> formatted HTML to avoid accidental replacements
    const masaSet = new Set();
    data.forEach(row => {
      const m = hitungMasa(row.tmt_masuk);
      if (m && m !== '-') masaSet.add(m);
    });

    let html = rawText;
    masaSet.forEach(m => {
      const escaped = m.replace(/[-/\^$*+?.()|[\]{}]/g, '\$&');
      const re = new RegExp(escaped, 'g');
      html = html.replace(re, formatMasaBlink(m));
    });

    document.getElementById('terminal').innerHTML = html;
  } catch (e) {
    console.error(e);
    document.getElementById('terminal').textContent = 'Gagal memuat data...';
  }
}

loadData();
</script>
</body>
</html>
