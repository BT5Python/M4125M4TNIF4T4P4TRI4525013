<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Personel Masuk - PUSLAT KODIKLATAU</title>
<style>
body {
  background-color: black;
  color: #00ff00;
  font-family: "Courier New", monospace;
  padding: 20px;
  font-size: 12px;
  text-align: left;
}
pre {
  white-space: pre-wrap;
  word-wrap: break-word;
  letter-spacing: 1px;
  line-height: 1.5;
  width: 100% !important;
  max-width: 100% !important;
  overflow-x: hidden !important;
  display: block;
}
.blink-merah { color:#ff0000; animation:blinkM 0.5s infinite; }
@keyframes blinkM {0%{color:#ff0000;} 50%{color:#330000;} 100%{color:#ff0000;}}
.baris-kedip-hijau { animation: kedipHijauBaris 0.6s infinite; }
@keyframes kedipHijauBaris {0%{background-color:rgba(0,255,0,0.1);}50%{background-color:rgba(0,80,0,0.3);}100%{background-color:rgba(0,255,0,0.1);}}
.baris-kedip-merah { animation: kedipMerahBaris 0.6s infinite; }
@keyframes kedipMerahBaris {0%{background-color:rgba(255,0,0,0.1);}50%{background-color:rgba(80,0,0,0.3);}100%{background-color:rgba(255,0,0,0.1);}}
button{
  background-color:black;
  color:#00ff00;
  border:1px solid #00ff00;
  padding:8px 18px;
  border-radius:8px;
  cursor:pointer;
  font-family:"Courier New", monospace;
  margin-right:10px;
}
button:hover{ background-color:#00ff00; color:black; font-weight:bold; }
.button-container{ margin-top:15px; }
</style>
</head>
<body>
<h2>>> FILE: PERSONEL MASUK</h2>
<pre id="terminal"></pre>
<div class="button-container">
  <button onclick="window.location.href='personelpuslat.html'">KEMBALI</button>
</div>
<script>
const API_URL = "https://script.google.com/macros/s/AKfycbwmvAgoBDuownzEn_tjJ2ixcJFs172vpvJy9mNhS4K-3pcKC-S05XdaLt7ifULlw17h/exec";
const SHEET_PERSONEL_MASUK = "Personel Masuk";

function escapeHtml(str){ if(!str) return ""; return String(str).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;"); }
function padRight(s,n){ s=s?String(s):""; return s.length>=n? s : s+" ".repeat(n-s.length); }

function toDate(v){ if(!v) return null; if(Object.prototype.toString.call(v)==="[object Date]"&&!isNaN(v)) return v; if(typeof v==="string"&&v.includes("T")){let d=new Date(v);if(!isNaN(d))return d;} if(typeof v==="string"&&(v.includes("/")||v.includes("-"))){let sep=v.includes("/")?"/":"-";let p=v.split(sep);if(p.length>=3){let d=new Date(parseInt(p[2]),parseInt(p[1])-1,parseInt(p[0])); if(!isNaN(d)) return d;}} if(!isNaN(v)){ let base=new Date(Date.UTC(1899,11,30)); let d=new Date(base.getTime()+v*86400000); if(!isNaN(d)) return d;} return null; }
function hitungMasa(tmt){ let s=toDate(tmt); if(!s) return "-"; let t=new Date(); let y=t.getFullYear()-s.getFullYear(); let m=t.getMonth()-s.getMonth(); let d=t.getDate()-s.getDate(); if(d<0){m--; d+= new Date(t.getFullYear(), t.getMonth(), 0).getDate();} if(m<0){y--; m+=12;} return `${y} th ${m} bln ${d} hr`; }

async function fetchData(){ try{let r=await fetch(API_URL+"?sheet="+encodeURIComponent(SHEET_PERSONEL_MASUK)); return await r.json(); }catch(e){return [];} }

function render(data){ let t=document.getElementById("terminal"); t.innerHTML="";
 t.innerHTML += `====================================================\n`;
 t.innerHTML += `|          DAFTAR PERSONEL MASUK (< 2 BULAN)        |\n`;
 t.innerHTML += `====================================================\n\n`;
 t.innerHTML += `NO    NAMA                          PANGKAT                 JABATAN                 TMT           MASA DINAS\n`;
 t.innerHTML += `---------------------------------------------------------------------------------------------------------------\n`;

 data.forEach(r=>{
    let masa=hitungMasa(r.tmt);
    let angka=masa.match(/\d+/g);
    let y=angka?parseInt(angka[0]):0;
    let b=angka&&angka[1]?parseInt(angka[1]):0;
    if(!(y===0 && b<2)) return;

    let line = padRight(r.no,5)+padRight(r.nama,30)+padRight(r.pangkat,25)+padRight(r.jabatan,25)+padRight(r.tmt,15)+masa;

    if(y===0 && b<2){ t.innerHTML += `<span class="baris-kedip-hijau">${escapeHtml(line)}</span>\n`; }
    else t.innerHTML += escapeHtml(line)+"\n";
 });

 t.innerHTML += `---------------------------------------------------------------------------------------------------------------\n`;
 t.innerHTML += `TOTAL PERSONEL MASUK (<2BLN): ` + data.filter(r=>{
    let m=hitungMasa(r.tmt); let a=m.match(/\d+/g); if(!a)return false;
    return parseInt(a[0])===0 && parseInt(a[1])<2;
 }).length + `\n`;
 t.innerHTML += `---------------------------------------------------------------------------------------------------------------\n`;
}

(async()=>{ let d=await fetchData(); render(d); })();
</script>
</body>
</html>
