<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>evolution is my revolution</title>
<style>
body {
  background-color: black;
  color: #00ff00;
  font-family: "Courier New", monospace;
  padding: 20px;
  font-size: 12px;
  text-align: left;
}
pre {
  white-space: pre-wrap;
  word-wrap: break-word;
  letter-spacing: 1px;
  line-height: 1.5;
  width: 100% !important;
  max-width: 100% !important;
  overflow-x: hidden !important;
  display: block;
}
.typing { border-right: 2px solid #00ff00; animation: blinkCursor 0.7s infinite; }
@keyframes blinkCursor { 50% { border-color: transparent; } }
.baris-kedip-hijau { animation: kedipHijauBaris 0.6s infinite; }
@keyframes kedipHijauBaris { 0% { background-color: rgba(0,255,0,0.1); } 50% { background-color: rgba(0,80,0,0.3); } 100% { background-color: rgba(0,255,0,0.1); } }
.baris-kedip-merah { animation: kedipMerahBaris 0.6s infinite; }
@keyframes kedipMerahBaris { 0% { background-color: rgba(255,0,0,0.1); } 50% { background-color: rgba(80,0,0,0.3); } 100% { background-color: rgba(255,0,0,0.1); } }
.blink-hijau { color: #00ff00; animation: kedipHijau 0.5s infinite; }
@keyframes kedipHijau { 0% { color: #00ff00; } 50% { color: #003300; } 100% { color: #00ff00; } }
.blink-merah { color: #ff0000; animation: kedipMerah 0.5s infinite; }
@keyframes kedipMerah { 0% { color: #ff0000; } 50% { color: #330000; } 100% { color: #ff0000; } }
.yellow { color: #ffff00; font-weight: bold; }
.hidden { display: none; }
.button-container { text-align: center; margin-top: 18px; }
button {
  background-color: black;
  color: #00ff00;
  border: 1px solid #00ff00;
  font-family: "Courier New", monospace;
  padding: 8px 18px;
  font-size: 12px;
  margin: 0 8px;
  border-radius: 8px;
  cursor: pointer;
  transition: 0.2s;
}
button:hover { background-color: #00ff00; color: black; font-weight: bold; }
button.download-btn { color: #ff0000; border-color: #ff0000; animation: blinkRedBtn 0.6s infinite; }
@keyframes blinkRedBtn { 0% { color: #ff0000; } 50% { color: #330000; } 100% { color: #ff0000; } }
button.download-btn:hover { background-color: #ff0000; color: black; animation: none; }
#runningText { color: #00ff00; white-space: nowrap; overflow: hidden; font-weight: bold; margin-bottom: 10px; }
#runningText span { display: inline-block; padding-left: 100%; animation: runText 15s linear infinite; }
@keyframes runText { from { transform: translateX(0); } to { transform: translateX(-100%); } }
.row-flex-fix { display:flex!important; flex-wrap:nowrap!important; gap:4px; align-items:center; justify-content:flex-start; overflow-x:auto; white-space:nowrap; }
.row-flex-fix > div { flex:0 0 auto; font-size:10px; padding:2px 4px; }
.row-flex-fix .col-nama { min-width: 60px; }
.row-flex-fix .col-pangkat { min-width: 45px; }
.row-flex-fix .col-jabatan { min-width: 90px; }
.row-flex-fix .col-tmt { min-width: 70px; }
.row-flex-fix .col-ket { min-width: 160px; }
</style>
</head>
<body>

<div id="loading">
  <p>>> initializing connection...</p>
  <p class="hidden">>>> accessing database node...</p>
  <p class="hidden">>>> verifying security clearance...</p>
  <p class="hidden">>>> clearance level verified ✓</p>
  <p class="hidden">>>> retrieving personel puslat...</p>
</div>

<div id="main" class="hidden">
  <div id="runningText"><span>⚠ THIS DATA IS CONFIDENTIAL - FOR THE KODIKLATAU CENTER ENVIRONMENT ONLY ⚠</span></div>
  <pre id="terminal" class="typing"></pre>
</div>

<div class="button-container hidden" id="buttons">
  <button onclick="tampilAnggotaMasuk()">Personel Masuk</button>
  <button onclick="tampilKeluar()">Personel Keluar</button>
  <button onclick="window.location.href='database.html'">back to DATABASE</button>
  <button class="download-btn" onclick="downloadFile()">⬇ DOWNLOAD</button>
</div>

<script>
const API_URL = "https://script.google.com/macros/s/AKfycbwmvAgoBDuownzEn_tjJ2ixcJFs172vpvJy9mNhS4K-3pcKC-S05XdaLt7ifULlw17h/exec";
const SHEET_DATABASE = "DATA2";
const SHEET_PERSONEL_MASUK = "Personel Masuk";
const SHEET_PERSONEL_KELUAR = "Personel Keluar";
const DOWNLOAD_URL = "https://drive.google.com/uc?export=download&id=1GAPWqs98GSMypnKYeow_oWzSYtAgzK6h";

const lines = document.querySelectorAll("#loading p");
let delay = 700;
lines.forEach((line, index) => {
  setTimeout(() => {
    line.classList.remove("hidden");
    if (index === lines.length - 1) {
      setTimeout(() => {
        document.getElementById("loading").style.display = "none";
        document.getElementById("main").classList.remove("hidden");
        startTyping();
      }, 900);
    }
  }, delay * (index + 1));
});

function toDateFromVariousFormats(v) {
  if (!v) return null;
  if (Object.prototype.toString.call(v) === "[object Date]" && !isNaN(v)) return v;
  if (typeof v === "string" && v.includes("T")) return new Date(v);
  if (typeof v === "string" && (v.includes("/") || v.includes("-"))) {
    const sep = v.includes("/") ? "/" : "-";
    const parts = v.split(sep);
    if (parts.length >= 3) return new Date(parseInt(parts[2],10), parseInt(parts[1],10)-1, parseInt(parts[0],10));
  }
  if (!isNaN(v)) return new Date(Date.UTC(1899,11,30) + Number(v)*24*3600*1000);
  return null;
}

function hitungMasa(tmt) {
  if (!tmt) return "-";
  const start = toDateFromVariousFormats(tmt);
  if (!start) return "-";
  const today = new Date();
  let y = today.getFullYear() - start.getFullYear();
  let m = today.getMonth() - start.getMonth();
  let d = today.getDate() - start.getDate();
  if (d<0){ m--; d += new Date(today.getFullYear(),today.getMonth(),0).getDate(); }
  if (m<0){ y--; m+=12; }
  return `${y} th ${m} bln ${d} hr`;
}

async function fetchDataFromSheet(sheetName = SHEET_DATABASE){
  try{
    const url = API_URL + "?sheet=" + encodeURIComponent(sheetName);
    const res = await fetch(url,{cache:"no-store"});
    if(!res.ok) throw new Error("Fetch gagal: " + res.status);
    const data = await res.json();
    return Array.isArray(data)?data:[];
  }catch(err){ console.error("fetchDataFromSheet error:",err); return []; }
}

function padRight(s,n){ s = s||""; return s.length>=n?s:s+" ".repeat(n-s.length); }
function escapeHtml(str){ if(!str) return ""; return String(str).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;"); }

function renderTableToTerminal(data, opts={}) {
  const terminal = document.getElementById("terminal");
  const cols = opts.columns || ["no","nama","pangkat","jabatan","tmt","keterangan"];
  const pads = opts.padWidths || [5,35,20,42,20,15];
  data.forEach(row=>{
    const obj = row && typeof row==="object"&&!Array.isArray(row)?row:{};
    const values = cols.map((c,idx)=>{
      const v = obj[c]!==undefined?obj[c]:"";
      return padRight(escapeHtml(v), pads[idx]||15);
    });
    const rawMasaText = hitungMasa(obj.tmt);
    let masaFix = rawMasaText;
    const angka = rawMasaText.match(/\d+/g);
    const tahun = angka?parseInt(angka[0]):0;
    const bulan = angka&&angka[1]?parseInt(angka[1]):0;
    let wrapStart="",wrapEnd="";
    if(tahun===0 && bulan<2){ wrapStart='<span class="baris-kedip-hijau">'; wrapEnd='</span>'; masaFix=`<span class="blink-hijau">${rawMasaText}</span>`;}
    else if(tahun>=2){ wrapStart='<span class="baris-kedip-merah">'; wrapEnd='</span>'; masaFix=`<span class="blink-merah">${rawMasaText}</span>`;}
    const line = `${values.join("")}${masaFix}\n`;
    const pangkatUpper = String(obj.pangkat||"").toUpperCase();
    const finalLine = pangkatUpper.includes("PNS")?`<span class="yellow">${line}</span>`:line;
    terminal.innerHTML += wrapStart+finalLine+wrapEnd;
  });
}

async function startTyping() {
  const terminal = document.getElementById("terminal");
  terminal.textContent="";
  const textBefore = "\n====================================\n| FILE: PERSONEL PUSLAT KODIKLATAU |\n| CLASSIFICATION: ";
  const rahasia = "RAHASIA";
  const textAfterTop = "\n====================================\n---------------------------------------------------------------------------------------------------------------\n";
  const footer = "\n---------------------------------------------------------------------------------------------------------------\n* Center personnel data is automatically updated from Spreadsheet\n* Information is only for the PUSLAT KODIKLATAU environment.\n---------------------------------------------------------------------------------------------------------------\n";
  for(let i=0;i<textBefore.length;i++){ terminal.textContent+=textBefore.charAt(i); await new Promise(r=>setTimeout(r,1)); }
  const spanRahasia=document.createElement("span"); spanRahasia.classList.add("blink-merah");
  terminal.appendChild(spanRahasia);
  for(let i=0;i<rahasia.length;i++){ spanRahasia.textContent+=rahasia.charAt(i); await new Promise(r=>setTimeout(r,30)); }
  for(let i=0;i<textAfterTop.length;i++){ terminal.innerHTML+=textAfterTop.charAt(i); await new Promise(r=>setTimeout(r,1)); }
  const data = await fetchDataFromSheet(SHEET_DATABASE);
  renderTableToTerminal(data,{columns:["no","nama","pangkat","jabatan","tmt","keterangan"],padWidths:[5,35,20,42,20,15]});
  terminal.innerHTML+=footer;
  terminal.classList.remove("typing");
  document.getElementById("buttons").classList.remove("hidden");
}

function downloadFile(){ window.open(DOWNLOAD_URL,"_blank"); }

async function tampilAnggotaMasuk(){
  const terminal=document.getElementById("terminal");
  terminal.innerHTML="";
  const data = await fetchDataFromSheet(SHEET_PERSONEL_MASUK);
  const hasil = data.filter(row=>{
    const tmt = row && typeof row==="object" && !Array.isArray(row)?row.tmt:(Array.isArray(row)?row[4]:null);
    const masa = hitungMasa(tmt);
    const angka = masa.match(/\d+/g);
    if(!angka) return false;
    const tahun=parseInt(angka[0]);
    const bulan = angka&&angka[1]?parseInt(angka[1]):0;
    return tahun===0 && bulan<2;
  });
  terminal.innerHTML+=`\n===============================================\n| LIST ANGGOTA MASUK (Masa < 2 Bulan)         |\n===============================================\n\nNO    NAMA                          PANGKAT                 JABATAN                 TMT           MASA DINAS\n---------------------------------------------------------------------------------------------------------------\n`;
  renderTableToTerminal(hasil,{columns:["no","nama","pangkat","jabatan","tmt"],padWidths:[5,30,25,25,15]});
  terminal.innerHTML+=`\n---------------------------------------------------------------------------------------------------------------\nTOTAL ANGGOTA MASUK: ${hasil.length}\n---------------------------------------------------------------------------------------------------------------\n`;
}

async function tampilKeluar(){
  const terminal=document.getElementById("terminal");
  terminal.innerHTML="";
  const data = await fetchDataFromSheet(SHEET_PERSONEL_KELUAR);
  renderTableToTerminal(data,{columns:["no","nama","pangkat","jabatan","tmt"],padWidths:[5,30,25,25,15]});
}
</script>
</body>
</html>
